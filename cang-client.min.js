var __slice=Array.prototype.slice;define("events",[],function(){var a;return a=function(){function a(){}return a.prototype.bind=function(a,b){var c,d,e,f,g,h;d=a.split(" "),c=this.hasOwnProperty("_callbacks")&&this._callbacks||(this._callbacks={}),h=[];for(f=0,g=d.length;f<g;f++)e=d[f],c[e]||(c[e]=[]),h.push(c[e].push(b));return h},a.prototype.on=a.prototype.bind,a.prototype.one=function(a,b){return this.bind(a,function(){return this.unbind(a,arguments.callee),b.apply(this,arguments)})},a.prototype.trigger=function(){var a,b,c,d,e,f,g;a=1<=arguments.length?__slice.call(arguments,0):[],c=a.shift(),d=this.hasOwnProperty("_callbacks")&&((g=this._callbacks)!=null?g[c]:void 0);if(!d)return;for(e=0,f=d.length;e<f;e++)b=d[e],b.apply(this,a);return!0},a.prototype.unbind=function(a,b){var c,d,e,f,g;if(!a)return this._callbacks={},this;e=(g=this._callbacks)!=null?g[a]:void 0;if(!e)return this;if(!b)return delete this._callbacks[a],this;for(d=0,f=e.length;d<f;d++){c=e[d];if(c!==b)continue;e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},a}()}),define("errors",[],function(){var a;return a={INVALID_KEY:function(a){var b;return b=a.id?"id":"type",new Error("invalid "+b+" '"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}}});var __bind=function(a,b){return function(){return a.apply(b,arguments)}};define("store",["errors"],function(a){var b;return b=function(){function b(a){this.app=a,this.clear=__bind(this.clear,this),this.is_persistent()||(this.db={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0},clear:function(){return null}}),this.app.on("account:signed_out",this.clear)}return b.prototype.db={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length},clear:function(){return window.localStorage.clear()}},b.prototype.save=function(b,c,d,e){var f,g;e==null&&(e={}),g=this.app.promise();if(typeof d!="object")return g.reject(a.INVALID_ARGUMENTS("object is "+typeof d)),g;d=$.extend({},d),c?f=typeof this._cached[""+b+"/"+c]!="object":(f=!0,c=this.uuid());if(!this._is_valid_key(c))return g.reject(a.INVALID_KEY({id:c}));if(!this._is_valid_key(b))return g.reject(a.INVALID_KEY({type:b}));e.remote?d._synced_at=this._now():(d.updated_at=this._now(),d.created_at||(d.created_at=d.updated_at)),delete d.id,delete d.type;try{d=this.cache(b,c,d,e),g.resolve(d,f)}catch(h){g.reject(h)}return g},b.prototype.create=function(a,b,c){return c==null&&(c={}),this.save(a,void 0,b)},b.prototype.update=function(a,b,c,d){var e,f=this;return d==null&&(d={}),e=this.app.promise(),this.load(a,b).fail(e.reject).done(function(d){return f.save(a,b,$.extend(d,c)).fail(e.reject).done(e.resolve)}),e},b.prototype.load=function(b,c){var d,e;e=this.app.promise();if(typeof b!="string"||typeof c!="string")return e.reject(a.INVALID_ARGUMENTS("type & id are required"));try{d=this.cache(b,c);if(!d)return e.reject(a.NOT_FOUND(b,c)),e;e.resolve(d)}catch(f){e.reject(f)}return e},b.prototype.loadAll=function(a){var b,c,d,e,f,g;e=this.app.promise(),d=this._index();try{f=function(){var e,f,h,i;i=[];for(e=0,f=d.length;e<f;e++){c=d[e];if(a!==void 0&&c.indexOf(a)!==0||!this._is_semantic_id(c))continue;h=c.split("/"),g=h[0],b=h[1],i.push(this.cache(g,b))}return i}.call(this),e.resolve(f)}catch(h){e.reject(h)}return e},b.prototype["delete"]=function(b,c,d){var e,f,g;return d==null&&(d={}),g=this.app.promise(),f=this.cache(b,c),f?(f._synced_at&&!d.remote?(f._deleted=!0,this.cache(b,c,f)):(e=""+b+"/"+c,this.db.removeItem(e),this._cached[e]=!1,this.clear_changed(b,c)),g.resolve($.extend({},f))):g.reject(a.NOT_FOUND(b,c))},b.prototype.destroy=b.prototype["delete"],b.prototype.cache=function(a,b,c,d){var e;c==null&&(c=!1),d==null&&(d={}),e=""+a+"/"+b;if(c){this._cached[e]=$.extend(c,{type:a,id:b}),this._setObject(a,b,c);if(d.remote)return this.clear_changed(a,b),$.extend({},this._cached[e])}else{if(this._cached[e]!=null)return $.extend({},this._cached[e]);this._cached[e]=this._getObject(a,b)}return this._cached[e]&&(this._is_dirty(this._cached[e])||this._is_marked_as_deleted(this._cached[e]))?this.mark_as_changed(a,b,this._cached[e]):this.clear_changed(a,b),this._cached[e]?$.extend({},this._cached[e]):this._cached[e]},b.prototype.clear_changed=function(a,b){var c;return a&&b?(c=""+a+"/"+b,delete this._dirty[c]):this._dirty={},this.app.trigger("store:dirty")},b.prototype.is_marked_as_deleted=function(a,b){return this._is_marked_as_deleted(this.cache(a,b))},b.prototype.mark_as_changed=function(a,b,c){var d,e,f=this;return d=""+a+"/"+b,this._dirty[d]=c,this.app.trigger("store:dirty"),e=2e3,window.clearTimeout(this._dirty_timeout),this._dirty_timeout=window.setTimeout(function(){return f.app.trigger("store:dirty:idle")},e)},b.prototype.changed_docs=function(){var a,b,c,d;c=this._dirty,d=[];for(a in c)b=c[a],d.push(b);return d},b.prototype.is_dirty=function(a,b){return a?this._is_dirty(this.cache(a,b)):$.isEmptyObject(this._dirty)},b.prototype.clear=function(){var a;a=this.app.promise();try{this.db.clear(),this._cached={},this.clear_changed(),a.resolve()}catch(b){a.reject(b)}return a},b.prototype.is_persistent=function(){try{if(!window.localStorage)return!1;localStorage.setItem("Storage-Test","1");if(localStorage.getItem("Storage-Test")!=="1")return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0},b.prototype.uuid=function(a){var b,c,d;return a==null&&(a=7),b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=b.length,function(){var e;e=[];for(c=0;0<=a?c<a:c>a;0<=a?c++:c--)e.push(b[0|Math.random()*d]);return e}().join("")},b.prototype._setObject=function(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,this.db.setItem(d,JSON.stringify(e))},b.prototype._getObject=function(a,b){var c,d,e;return d=""+a+"/"+b,c=this.db.getItem(d),c?(e=JSON.parse(c),e.type=a,e.id=b,e.created_at&&(e.created_at=new Date(Date.parse(e.created_at))),e.updated_at&&(e.updated_at=new Date(Date.parse(e.updated_at))),e._synced_at&&(e._synced_at=new Date(Date.parse(e._synced_at))),e):!1},b.prototype._now=function(){return new Date},b.prototype._is_valid_key=function(a){return/^[a-z0-9]+$/.test(a)},b.prototype._is_semantic_id=function(a){return/^[a-z0-9]+\/[a-z0-9]+$/.test(a)},b.prototype._cached={},b.prototype._dirty={},b.prototype._is_dirty=function(a){return a._synced_at?a.updated_at?a._synced_at.getTime()<a.updated_at.getTime():!1:!0},b.prototype._is_marked_as_deleted=function(a){return a._deleted===!0},b.prototype._index=function(){var a,b,c;c=[];for(a=0,b=this.db.length();0<=b?a<b:a>b;0<=b?a++:a--)c.push(this.db.key(a));return c},b}()});var __bind=function(a,b){return function(){return a.apply(b,arguments)}};define("account",[],function(){var a;return a=function(){function a(a){this.app=a,this._handle_sign_out=__bind(this._handle_sign_out,this),this._handle_sign_in=__bind(this._handle_sign_in,this),this.email=this.app.store.db.getItem("_couch.account.email"),this.authenticate(),this.app.on("account:signed_in",this._handle_sign_in),this.app.on("account:signed_out",this._handle_sign_out)}return a.prototype.email=void 0,a.prototype.authenticate=function(){var a,b=this;return a=this.app.promise(),this.email?this._authenticated===!0?a.resolve(this.email):this._authenticated===!1?a.reject():(this.app.request("GET","/_session",{success:function(c){return c.userCtx.name?(b._authenticated=!0,b.email=c.userCtx.name,a.resolve(b.email)):(b._authenticated=!1,b.app.trigger("account:error:not_authenticated"),a.reject())},error:a.reject}),a):a.reject()},a.prototype.sign_up=function(a,b){var c,d,e=this;return d="org.couchdb.user",c=""+d+":"+a,this.app.request("PUT","/_users/"+encodeURIComponent(c),{data:JSON.stringify({_id:c,name:a,type:"user",roles:[],password:b}),contentType:"application/json",success:function(){return e.app.trigger("account:signed_up",a),e.app.trigger("account:signed_in",a)}})},a.prototype.sign_in=function(a,b){var c=this;return this.app.request("POST","/_session",{data:{name:a,password:b},success:function(){return c.app.trigger("account:signed_in",a)}})},a.prototype.login=a.prototype.sign_in,a.prototype.change_password=function(a,b){return alert("change password is not yet implementd")},a.prototype.sign_out=function(){var a=this;return this.app.request("DELETE","/_session",{success:function(){return a.app.trigger("account:signed_out")}})},a.prototype.logout=a.prototype.sign_out,a.prototype._handle_sign_in=function(a){return this.email=a,this.app.store.db.setItem("_couch.account.email",this.email),this._authenticated=!0},a.prototype._handle_sign_out=function(){return delete this.email,this.app.store.db.removeItem("_couch.account.email"),this._authenticated=!1},a}()});var __bind=function(a,b){return function(){return a.apply(b,arguments)}};define("remote",["errors"],function(a){var b;return b=function(){function a(a){this.app=a,this._handle_push_changes=__bind(this._handle_push_changes,this),this._handle_pull_changes=__bind(this._handle_pull_changes,this),this._changes_error=__bind(this._changes_error,this),this._changes_success=__bind(this._changes_success,this),this._restart_changes_request=__bind(this._restart_changes_request,this),this.push_changes=__bind(this.push_changes,this),this.pull_changes=__bind(this.pull_changes,this),this.disconnect=__bind(this.disconnect,this),this.connect=__bind(this.connect,this),this.app.on("account:signed_in",this.connect),this.app.on("account:signed_out",this.disconnect),this.connect()}return a.prototype.connect=function(){var a=this;if(this._connected)return;return this.app.account.authenticate().done(function(){return a.app.on("store:dirty:idle",a.push_changes),a.pull_changes(),a.push_changes()})},a.prototype.disconnect=function(){return this._connected=!1,this._changes_request&&this._changes_request.abort(),this.app.store.db.removeItem("_couch.remote.seq"),this.app.unbind("store:dirty:idle",this.push_changes),delete this._seq},a.prototype.pull_changes=function(){return this._connected=!0,this._changes_request=this.app.request("GET",this._changes_path(),{success:this._changes_success,error:this._changes_error}),window.clearTimeout(this._changes_request_timeout),this._changes_request_timeout=window.setTimeout(this._restart_changes_request,25e3)},a.prototype.push_changes=function(a){var b,c;return c=this.app.store.changed_docs(),c.length===0?this._promise().resolve([]):(c=function(){var a,d,e;e=[];for(a=0,d=c.length;a<d;a++)b=c[a],e.push(this._parse_for_remote(b));return e}.call(this),this.app.request("POST","/"+encodeURIComponent(this.app.account.email)+"/_bulk_docs",{dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify({docs:c}),success:this._handle_push_changes}))},a.prototype.get_seq=function(){return this._seq||(this._seq=this.app.store.db.getItem("_couch.remote.seq")||0)},a.prototype.set_seq=function(a){return this._seq=this.app.store.db.setItem("_couch.remote.seq",a)},a.prototype.on=function(a,b){return this.app.on("remote:"+a,b)},a.prototype._changes_path=function(){var a,b;return b=this.get_seq(),a="joe_example_com","/"+encodeURIComponent(this.app.account.email)+"/_changes?include_docs=true&heartbeat=10000&feed=longpoll&since="+b},a.prototype._restart_changes_request=function(){var a;return(a=this._changes_request)!=null?a.abort():void 0},a.prototype._changes_success=function(a){if(!this._connected)return;return this.set_seq(a.last_seq),this._handle_pull_changes(a.results),this.pull_changes()},a.prototype._changes_error=function(a,b,c){if(!this._connected)return;switch(a.status){case 403:return this.trigger("error:unauthorized"),this.disconnect();case 404:return window.setTimeout(this.pull_changes,3e3);case 500:return this.trigger("error:server"),this.disconnect();default:return a.statusText==="abort"?this.pull_changes():window.setTimeout(this.pull_changes,3e3)}},a.prototype._valid_special_attributes={_id:1,_rev:1,_deleted:1},a.prototype._parse_for_remote=function(a){var b,c;c=$.extend({},a);for(b in c){if(this._valid_special_attributes[b])continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,delete c.id,c},a.prototype._parse_from_remote=function(a){var b,c;return b=a._id||a.id,delete a._id,c=b.split(/\//),a.type=c[0],a.id=c[1],a.created_at&&(a.created_at=new Date(Date.parse(a.created_at))),a.updated_at&&(a.updated_at=new Date(Date.parse(a.updated_at))),a},a.prototype._handle_pull_changes=function(a){var b,c,d,e,f,g=this;f=[];for(d=0,e=a.length;d<e;d++)b=a[d].doc,c=this._parse_from_remote(b),c._deleted?f.push(this.app.store.destroy(c.type,c.id,{remote:!0}).done(function(a){return g.app.trigger("remote:destroyed",c.type,c.id,a),g.app.trigger("remote:destroyed:"+c.type,c.id,a),g.app.trigger("remote:changed",c.type,c.id,a),g.app.trigger("remote:changed:"+c.type,c.id,a)})):f.push(this.app.store.save(c.type,c.id,c,{remote:!0}).done(function(a,b){return g.app.trigger("remote:changed",c.type,c.id,a),g.app.trigger("remote:changed:"+c.type,c.id,a),b?(g.app.trigger("remote:created",c.type,c.id,a),g.app.trigger("remote:created:"+c.type,c.id,a)):(g.app.trigger("remote:updated",c.type,c.id,a),g.app.trigger("remote:updated:"+c.type,c.id,a))}));return f},a.prototype._handle_push_changes=function(a){},a.prototype._promise=$.Deferred,a}()});var __hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};define("cang",["events","store","account","remote"],function(a,b,c,d){var e;return e=function(a){function e(a){this.couchDB_url=a,this.couchDB_url=this.couchDB_url.replace(/\/+$/,""),this.store=new b(this),this.account=new c(this),this.remote=new d(this)}return __extends(e,a),e.prototype.request=function(a,b,c){var d;return c==null&&(c={}),d={type:a,url:""+this.couchDB_url+b,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},$.ajax($.extend(d,c))},e.prototype.promise=$.Deferred,e}(a)})